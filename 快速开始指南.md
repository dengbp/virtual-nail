# Reference-Only 美甲迁移 - 快速开始指南

## 🚀 一键安装（推荐）

### 1. 运行自动安装脚本
```bash
python auto_install_reference_only.py
```

这个脚本会**智能检测**现有环境并自动：
- ✅ 检查Python版本和Git
- ✅ **智能检测现有WebUI环境**（避免重复安装）
- ✅ **智能检测现有模型**（SDXL、Canny、Depth等）
- ✅ 安装Python依赖包
- ✅ 安装/更新ControlNet扩展
- ✅ 只下载缺失的模型文件
- ✅ 创建启动脚本
- ✅ 创建测试脚本

### 2. 智能环境检测

脚本会自动检测：
- **现有WebUI**：当前目录、上级目录、上上级目录
- **现有模型**：
  - 基础模型：`*.safetensors`, `*.ckpt`
  - ControlNet模型：`*.pth`
  - 特别检测Canny、Depth等常用模型
- **现有扩展**：ControlNet扩展

**如果检测到现有环境，脚本会：**
- ✅ 使用现有WebUI，不重复下载
- ✅ 跳过已存在的模型，只下载缺失的
- ✅ 更新ControlNet扩展到最新版本

### 3. 模型文件处理

#### 自动检测结果
脚本会显示类似这样的信息：
```
✅ 发现现有WebUI: D:\stable-diffusion-webui
✅ 发现ControlNet扩展: D:\stable-diffusion-webui\extensions\sd-webui-controlnet
✅ 发现基础模型: 3 个
   - sd_xl_base_1.0.safetensors
   - v1-5-pruned.safetensors
   - dreamshaper_8.safetensors
✅ 发现ControlNet模型: 5 个
   - control_v11p_sd15_canny.pth
   - control_v11p_sd15_depth.pth
   - control_v11p_sd15_softedge.pth
   - control_v11p_sd15_openpose.pth
   - control_v11p_sd15_mlsd.pth
```

#### 只下载缺失模型
如果检测到缺少必要模型，脚本会：
1. 显示缺失的模型列表
2. 询问是否自动下载
3. 只下载缺失的模型，不重复下载已有的

### 4. 启动WebUI
```bash
# Windows
双击 start_webui.bat

# Linux/Mac
./start_webui.sh
```

### 5. 测试安装
```bash
python quick_test.py
```

## 📁 文件结构
安装完成后，你的目录结构可能是：
```
nail-color-preview/
├── auto_install_reference_only.py    # 自动安装脚本
├── nail_reference_only_transfer.py   # 主要迁移脚本
├── test_reference_only_transfer.py   # 完整测试脚本
├── quick_test.py                     # 快速测试脚本
├── start_webui.bat                   # Windows启动脚本
├── start_webui.sh                    # Linux/Mac启动脚本
├── stable-diffusion-webui/           # WebUI目录（如果新建）
│   ├── models/
│   │   ├── Stable-diffusion/
│   │   │   └── v1-5-pruned.safetensors
│   │   └── ControlNet/
│   │       └── control_v11p_sd15_canny.pth
│   └── extensions/
│       └── sd-webui-controlnet/
└── data/                             # 测试图像目录
    ├── hand_photo.jpg
    └── nail_sample.jpg
```

**或者使用现有WebUI**：
```
your-existing-webui/                  # 现有WebUI目录
├── models/
│   ├── Stable-diffusion/
│   │   ├── sd_xl_base_1.0.safetensors    # 已有
│   │   ├── v1-5-pruned.safetensors       # 已有
│   │   └── dreamshaper_8.safetensors     # 已有
│   └── ControlNet/
│       ├── control_v11p_sd15_canny.pth   # 已有
│       ├── control_v11p_sd15_depth.pth   # 已有
│       └── control_v11p_sd15_softedge.pth # 已有
└── extensions/
    └── sd-webui-controlnet/              # 自动更新

nail-color-preview/                   # 项目目录
├── auto_install_reference_only.py
├── nail_reference_only_transfer.py
├── start_webui.bat                   # 指向现有WebUI
└── ...
```

## 🎯 使用方法

### 基本使用
```python
from nail_reference_only_transfer import NailReferenceOnlyTransfer

# 初始化
transfer = NailReferenceOnlyTransfer()

# 执行迁移
result = transfer.process_nail_transfer(
    hand_image_path="你的手部照片.jpg",
    nail_sample_path="指甲样板.jpg",
    output_path="结果.jpg"
)
```

### 参数调优
```python
result = transfer.transfer_with_reference_only(
    hand_image=hand_image,
    nail_sample=nail_sample,
    mask=mask,
    strength=0.8,        # Reference-Only强度
    cfg_scale=7.0,       # CFG比例
    steps=20             # 推理步数
)
```

## 🔧 常见问题

### Q: 脚本检测不到我的现有WebUI？
**A**: 脚本会检查以下位置：
1. 当前目录下的 `stable-diffusion-webui`
2. 上级目录下的 `stable-diffusion-webui`
3. 上上级目录下的 `stable-diffusion-webui`

如果都不在，可以手动指定路径或让脚本新建一个。

### Q: 脚本重复下载了已有的模型？
**A**: 脚本会智能检测现有模型，只下载缺失的。如果出现重复下载，可能是：
1. 模型文件名不标准
2. 模型文件损坏
3. 检测逻辑有误

### Q: 安装脚本运行失败？
**A**: 检查：
1. Python版本 ≥ 3.8
2. Git已安装
3. 网络连接正常
4. 磁盘空间充足

### Q: 模型文件下载失败？
**A**: 
1. 使用VPN或代理
2. 手动下载并放置到正确目录
3. 检查磁盘空间是否充足

### Q: WebUI启动失败？
**A**: 
1. 检查模型文件是否在正确位置
2. 确认端口7860未被占用
3. 查看错误日志

### Q: API连接失败？
**A**: 
1. 确保WebUI正在运行
2. 检查启动参数是否包含`--api`
3. 确认ControlNet扩展已正确安装

## 📊 性能要求

### 最低配置
- **显卡**：NVIDIA 6GB显存
- **内存**：16GB RAM
- **存储**：10GB可用空间

### 推荐配置
- **显卡**：NVIDIA 8GB+显存
- **内存**：32GB RAM
- **存储**：20GB可用空间

## 🎨 效果预览

使用Reference-Only预处理器可以获得：
- ✅ 更自然的颜色迁移
- ✅ 更好的纹理保持
- ✅ 减少后处理步骤
- ✅ 更高的生成质量

## 🚀 智能检测优势

### 节省时间
- 不重复下载已有模型
- 不重复安装已有软件
- 只更新必要的组件

### 节省空间
- 复用现有WebUI环境
- 复用现有模型文件
- 避免重复存储

### 兼容性好
- 支持多种WebUI位置
- 支持多种模型格式
- 自动适配现有环境

## 📞 技术支持

如果遇到问题：
1. 查看本文档的常见问题部分
2. 运行`python quick_test.py`诊断
3. 检查日志文件
4. 提交Issue到项目仓库

---

**开始使用**：运行 `python auto_install_reference_only.py` 开始智能安装！ 